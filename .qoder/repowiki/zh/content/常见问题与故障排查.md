# 常见问题与故障排查

<cite>
**本文档引用文件**  
- [README.md](file://README.md)
- [web/README.md](file://web/README.md)
- [Dockerfile](file://Dockerfile)
- [run.py](file://run.py)
- [deploy/web.conf](file://deploy/web.conf)
- [app/core/dependency.py](file://app/core/dependency.py)
- [app/utils/jwt_utils.py](file://app/utils/jwt_utils.py)
- [app/api/v1/base/base.py](file://app/api/v1/base/base.py)
- [app/settings/config.py](file://app/settings/config.py)
- [web/src/router/guard/index.js](file://web/src/router/guard/index.js)
- [web/src/utils/http/interceptors.js](file://web/src/utils/http/interceptors.js)
- [web/src/directives/permission.js](file://web/src/directives/permission.js)
- [web/src/views/login/index.vue](file://web/src/views/login/index.vue)
- [web/vite.config.js](file://web/vite.config.js)
- [web/build/constant.js](file://web/build/constant.js)
- [app/api/v1/menus/menus.py](file://app/api/v1/menus/menus.py)
- [app/controllers/menu.py](file://app/controllers/menu.py)
- [Makefile](file://Makefile)
- [app/log/log.py](file://app/log/log.py)
</cite>

## 目录
1. [简介](#简介)
2. [常见问题与解决方案](#常见问题与解决方案)
   - [前端无法连接后端（CORS问题）](#前端无法连接后端cors问题)
   - [登录失败，返回401](#登录失败返回401)
   - [数据库迁移失败](#数据库迁移失败)
   - [Docker 部署后应用无法访问](#docker-部署后应用无法访问)
   - [动态菜单不显示](#动态菜单不显示)
   - [权限分配后前端按钮仍不可见](#权限分配后前端按钮仍不可见)
3. [日志与诊断方法](#日志与诊断方法)
4. [性能调优建议](#性能调优建议)
5. [附录：已知问题与社区支持](#附录已知问题与社区支持)

## 简介
本手册旨在帮助新用户和开发者快速解决在使用 `vue-fastapi-admin` 项目过程中可能遇到的常见问题。涵盖前后端连接、认证授权、部署、权限控制等核心场景，并提供详细的排查步骤与解决方案。同时指导如何查阅日志、前端控制台信息以及网络请求，以提升问题定位效率。

## 常见问题与解决方案

### 前端无法连接后端（CORS问题）

**问题描述**  
开发环境下，前端运行在 `http://localhost:3100`，后端运行在 `http://127.0.0.1:9999`，浏览器报错跨域（CORS）。

**诊断步骤**  
1. 检查浏览器开发者工具的 **Network** 标签页，确认请求是否被拦截，错误信息是否包含 `CORS header 'Access-Control-Allow-Origin' missing`。
2. 确认后端是否已启用 CORS 中间件。
3. 检查前端 Vite 配置中的代理设置。

**解决方案**  
本项目通过 Vite 的代理功能解决开发环境 CORS 问题，而非后端设置 CORS 头。请确保前端配置正确：

- 查看 `web/vite.config.js` 中的 `server.proxy` 配置。
- 确认 `VITE_USE_PROXY` 环境变量为 `true`，且 `VITE_BASE_API` 与 `build/constant.js` 中的代理键匹配（如 `/api/v1`）。

```js
// web/build/constant.js
'/api/v1': {
  target: 'http://127.0.0.1:9999',
  changeOrigin: true,
}
```

**注意**：生产环境通过 Nginx 反向代理解决跨域，参考 `deploy/web.conf`。

**Section sources**
- [web/vite.config.js](file://web/vite.config.js#L30-L40)
- [web/build/constant.js](file://web/build/constant.js#L10-L20)
- [deploy/web.conf](file://deploy/web.conf#L8-L12)

### 登录失败，返回401

**问题描述**  
用户输入正确用户名密码，但登录接口返回 401 Unauthorized。

**诊断步骤**  
1. 检查前端控制台是否有错误日志，特别是 `login error` 相关输出。
2. 查看后端日志文件 `app/log/log.py` 或控制台输出，搜索 `Authentication failed` 或 `无效的Token`。
3. 确认请求头中是否携带了 `token` 字段。
4. 检查 JWT 密钥配置是否正确。

**解决方案**  
1. **开发模式特殊 Token**：后端代码支持开发模式使用固定 Token `"dev"` 跳过认证（见 `app/core/dependency.py`）。若使用此模式，请确保前端发送 `token: "dev"`。
2. **正式登录流程**：
   - 前端调用 `/api/v1/access_token` 接口，传入用户名密码。
   - 后端验证通过后返回 JWT Token（见 `app/api/v1/base/base.py`）。
   - 前端需将返回的 `access_token` 存储并用于后续请求（见 `web/src/views/login/index.vue`）。
3. **检查 JWT 配置**：确认 `app/settings/config.py` 中的 `SECRET_KEY` 和 `JWT_ALGORITHM` 配置正确且未泄露。

**Section sources**
- [app/core/dependency.py](file://app/core/dependency.py#L10-L35)
- [app/api/v1/base/base.py](file://app/api/v1/base/base.py#L20-L35)
- [web/src/views/login/index.vue](file://web/src/views/login/index.vue#L89-L107)
- [app/utils/jwt_utils.py](file://app/utils/jwt_utils.py#L5-L9)

### 数据库迁移失败

**问题描述**  
执行 `make migrate` 或 `aerich migrate` 时失败，提示数据库连接错误或迁移冲突。

**诊断步骤**  
1. 检查 `.env` 文件中的数据库连接配置。
2. 确认数据库服务（如 SQLite、MySQL）是否正在运行。
3. 查看 `migrations` 目录是否存在冲突的迁移文件。
4. 检查 `app/settings/config.py` 中的 `TORTOISE_ORM` 配置。

**解决方案**  
1. **初始化或重置数据库**：
   ```bash
   make clean-db  # 删除迁移文件和数据库
   make migrate   # 重新生成迁移
   make upgrade   # 应用迁移
   ```
2. **配置数据库**：修改 `app/settings/config.py` 中的数据库配置（默认为 SQLite），确保路径和权限正确。
3. **环境变量**：建议使用 `.env` 文件管理数据库连接信息，避免硬编码。

**Section sources**
- [Makefile](file://Makefile#L70-L86)
- [app/settings/config.py](file://app/settings/config.py#L34-L93)
- [pyproject.toml](file://pyproject.toml#L80-L88)

### Docker 部署后应用无法访问

**问题描述**  
使用 `Dockerfile` 构建并运行容器后，无法通过 `http://localhost:9999` 访问应用。

**诊断步骤**  
1. 确认容器是否正常运行：`docker ps`。
2. 检查容器日志：`docker logs <container_id>`，查看是否有启动错误。
3. 确认端口映射是否正确：`docker run -p 9999:9999 ...`。
4. 检查 `run.py` 中的 `host="0.0.0.0"` 是否设置，确保监听所有接口。

**解决方案**  
1. **确保 `run.py` 正确配置**：
   ```python
   uvicorn.run("app:app", host="0.0.0.0", port=9999, ...)
   ```
2. **检查 `Dockerfile` 构建过程**，确保所有依赖已安装。
3. **生产环境建议使用 Nginx**：参考 `deploy/web.conf` 配置，前端静态文件由 Nginx 提供，后端 API 通过 `proxy_pass` 转发。

**Section sources**
- [Dockerfile](file://Dockerfile)
- [run.py](file://run.py#L10-L12)
- [deploy/web.conf](file://deploy/web.conf#L1-L12)

### 动态菜单不显示

**问题描述**  
用户登录后，左侧菜单栏为空，动态菜单未加载。

**诊断步骤**  
1. 检查前端 Network 请求，确认 `/api/v1/menus/list` 是否成功返回菜单数据。
2. 查看后端日志，确认 `menus.py` 中的 `list_menu` 接口是否被调用。
3. 检查数据库 `menu` 表中是否存在有效的菜单记录。

**解决方案**  
1. **确认菜单数据存在**：通过数据库工具检查 `menu` 表，确保有 `parent_id=0` 的根菜单。
2. **检查接口实现**：后端 `app/api/v1/menus/menus.py` 中的 `list_menu` 接口递归查询子菜单，确保逻辑正确。
3. **前端路由加载**：登录成功后，前端应调用 `addDynamicRoutes()` 动态添加路由（见 `index.vue`）。

**Section sources**
- [app/api/v1/menus/menus.py](file://app/api/v1/menus/menus.py#L10-L30)
- [app/controllers/menu.py](file://app/controllers/menu.py#L10-L16)
- [web/src/views/login/index.vue](file://web/src/views/login/index.vue#L95-L96)

### 权限分配后前端按钮仍不可见

**问题描述**  
用户被分配了某接口权限，但前端使用 `v-permission` 指令的按钮仍未显示。

**诊断步骤**  
1. 检查用户角色是否正确关联了目标 API 权限。
2. 查看登录后返回的权限列表（`accessApis`）是否包含该权限。
3. 检查前端 `v-permission` 指令的值是否与后端 API 路径完全一致。

**解决方案**  
1. **权限指令实现**：前端 `src/directives/permission.js` 中的 `hasPermission` 函数检查 `accessApis` 数组是否包含指令值。
2. **超级用户豁免**：`isSuperUser` 用户不受权限限制，可显示所有按钮。
3. **确保权限同步**：用户登录或权限变更后，需重新获取权限列表并更新 `userPermissionStore`。

**Section sources**
- [web/src/directives/permission.js](file://web/src/directives/permission.js#L5-L30)
- [app/api/v1/apis/apis.py](file://app/api/v1/apis/apis.py) （权限数据来源）
- [app/controllers/api.py](file://app/controllers/api.py) （权限控制逻辑）

## 日志与诊断方法

### 后端日志
- 日志文件位于 `app/log/log.py`。
- 启动命令 `python run.py` 会输出格式化日志（时间、级别、消息）。
- 关键日志点：认证失败、数据库错误、API 调用。

### 前端控制台
- 打开浏览器开发者工具，查看 **Console** 和 **Network**。
- `resReject` 函数（`interceptors.js`）会捕获 401 并自动登出用户。
- 登录错误会打印 `login error` 及详细信息。

### 网络请求
- 检查请求 URL、方法、请求头（尤其是 `token`）、请求体。
- 确认响应状态码和返回数据结构。

**Section sources**
- [app/log/log.py](file://app/log/log.py)
- [run.py](file://run.py#L5-L12)
- [web/src/utils/http/interceptors.js](file://web/src/utils/http/interceptors.js#L40-L60)

## 性能调优建议

### 数据库索引优化
- 为频繁查询的字段添加索引，如 `user.username`、`menu.path`、`role.name`。
- 使用 Tortoise ORM 的 `index=True` 或 `unique=True` 定义模型字段。

### 缓存策略
- 对静态菜单、权限列表等不频繁变动的数据，考虑在前端或 Redis 中缓存。
- 减少重复的 `/api/v1/menus/list` 请求。

### 前端构建优化
- 确保 `vite.config.js` 中 `build.chunkSizeWarningLimit` 设置合理。
- 使用 `unocss` 按需生成 CSS，减少包体积。

**Section sources**
- [app/models/admin.py](file://app/models/admin.py) （模型定义）
- [vite.config.js](file://web/vite.config.js#L40-L43)

## 附录：已知问题与社区支持

### 查阅文档
- 详细部署和配置说明请参考 `README.md` 和 `web/README.md`。
- 安全建议见 `AGENTS.md`，如定期轮换 JWT 密钥。

### 社区支持
- 在 GitHub Issues 中搜索类似问题。
- 提交新问题时，请附上：
  - 完整错误日志
  - 复现步骤
  - 环境信息（Python、Node.js 版本）
  - 相关代码片段路径

**Section sources**
- [README.md](file://README.md)
- [web/README.md](file://web/README.md)
- [AGENTS.md](file://AGENTS.md#L26-L29)