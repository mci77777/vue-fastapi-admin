# 部署与运维

<cite>
**本文档中引用的文件**  
- [Dockerfile](file://Dockerfile#L1-L33)
- [deploy/entrypoint.sh](file://deploy/entrypoint.sh#L1-L5)
- [deploy/web.conf](file://deploy/web.conf#L1-L13)
- [Makefile](file://Makefile#L1-L87)
- [run.py](file://run.py#L1-L14)
- [app/settings/config.py](file://app/settings/config.py#L1-L95)
- [web/package.json](file://web/package.json#L1-L61)
- [web/vite.config.js](file://web/vite.config.js#L1-L45)
</cite>

## 目录
1. [简介](#简介)
2. [Docker 部署](#docker-部署)
3. [直接部署](#直接部署)
4. [入口脚本与初始化](#入口脚本与初始化)
5. [Makefile 便捷命令](#makefile-便捷命令)
6. [生产环境配置建议](#生产环境配置建议)
7. [访问应用与 API 文档](#访问应用与-api-文档)

## 简介
本指南详细说明了 `vue-fastapi-admin` 项目的部署与运维方案，涵盖 Docker 部署、直接部署、容器初始化流程、便捷构建命令及生产环境最佳实践。系统由基于 FastAPI 的后端和基于 Vue 的前端组成，通过 Nginx 统一托管。

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L33)
- [app/settings/config.py](file://app/settings/config.py#L1-L95)

## Docker 部署

### Dockerfile 指令详解
`Dockerfile` 采用多阶段构建策略，分为前端构建和后端服务两个阶段：

1. **前端构建阶段 (web)**  
   使用 `node:20.19.4-alpine` 镜像，进入工作目录 `/opt/vue-fastapi-admin`，复制 `web` 目录内容，安装依赖并执行 `npm run build` 构建前端静态资源。

2. **后端服务阶段**  
   基于 `python:3.11-slim-bullseye` 镜像，复制项目文件和 `entrypoint.sh` 脚本。配置国内软件源、时区（Asia/Shanghai），安装编译依赖和运行时工具（gcc, nginx 等）。使用清华源安装 Python 依赖。

3. **前端资源集成**  
   从 `web` 阶段复制构建好的 `dist` 目录到容器中，并配置 Nginx 服务，将前端静态文件托管在根路径，API 请求代理至本地 9999 端口。

4. **环境与入口**  
   设置中文环境变量，暴露 80 端口，指定 `entrypoint.sh` 为容器启动入口。

### 构建与运行
```bash
# 构建镜像
docker build -t vue-fastapi-admin .

# 运行容器
docker run -d -p 80:80 --name admin-container vue-fastapi-admin
```

或使用 `docker-compose.yml` 示例：
```yaml
version: '3'
services:
  app:
    build: .
    ports:
      - "80:80"
    environment:
      - DEBUG=False
    volumes:
      - ./logs:/opt/vue-fastapi-admin/app/logs
```

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L33)
- [deploy/web.conf](file://deploy/web.conf#L1-L13)

## 直接部署

### 后端启动
使用 `run.py` 脚本直接启动 FastAPI 应用：
```bash
python run.py
```
该脚本通过 Uvicorn 启动服务，监听 `0.0.0.0:9999`，并自定义了日志格式（包含时间、日志级别和请求信息）。

### 前端构建与 Nginx 托管
1. **构建前端**
   ```bash
   cd web
   pnpm install
   pnpm build
   ```
   构建产物位于 `web/dist` 目录。

2. **Nginx 配置**
   `deploy/web.conf` 配置 Nginx：
   - 根路径 (`/`) 指向 `web/dist`，支持前端路由 `try_files $uri /index.html;`
   - `/api/` 路径反向代理至 `http://127.0.0.1:9999`

   将配置文件链接至 Nginx 并重启服务：
   ```bash
   sudo ln -s /path/to/deploy/web.conf /etc/nginx/sites-enabled/
   sudo systemctl restart nginx
   ```

**Section sources**
- [run.py](file://run.py#L1-L14)
- [deploy/web.conf](file://deploy/web.conf#L1-L13)
- [web/package.json](file://web/package.json#L1-L61)
- [web/vite.config.js](file://web/vite.config.js#L1-L45)

## 入口脚本与初始化
`deploy/entrypoint.sh` 是容器启动时执行的脚本：
```bash
#!/bin/sh
set -e

nginx
python run.py
```
它首先启动 Nginx 服务，然后启动 Python 后端应用。`set -e` 确保任一命令失败时脚本立即退出。

**Section sources**
- [deploy/entrypoint.sh](file://deploy/entrypoint.sh#L1-L5)

## Makefile 便捷命令
`Makefile` 提供了一系列便捷命令：

| 命令 | 描述 |
|------|------|
| `make help` | 显示所有可用命令及环境信息 |
| `make start` 或 `make run` | 启动后端服务 |
| `make check` | 检查代码格式与 lint |
| `make format` | 格式化代码 (black + isort) |
| `make lint` | 运行 ruff 进行代码检查 |
| `make test` | 运行测试套件 |
| `make clean-db` | 清理数据库文件和迁移记录 |
| `make migrate` | 生成数据库迁移文件 (aerich) |
| `make upgrade` | 应用数据库迁移 (aerich) |

**Section sources**
- [Makefile](file://Makefile#L1-L87)

## 生产环境配置建议

### 环境变量管理
通过 `.env` 文件或环境变量覆盖 `app/settings/config.py` 中的默认配置，关键配置包括：
- `DEBUG=False`：关闭调试模式
- `SECRET_KEY`：使用强随机密钥
- `TORTOISE_ORM`：切换至生产级数据库（如 PostgreSQL/MySQL）
- `CORS_ORIGINS`：限制允许的跨域来源

### 日志轮转
建议使用 `logrotate` 管理日志文件，避免日志无限增长。示例配置：
```bash
/opt/vue-fastapi-admin/app/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 644 root root
}
```

### 监控
- **进程监控**：使用 `supervisord` 或 `systemd` 管理后端进程。
- **日志监控**：集成 ELK 或使用 `Prometheus` + `Grafana` 进行指标监控。
- **健康检查**：通过 `/api/health` 端点进行服务健康检查。

**Section sources**
- [app/settings/config.py](file://app/settings/config.py#L1-L95)

## 访问应用与 API 文档
- **前端应用**：`http://localhost` (Nginx 80端口)
- **API 文档 (Swagger UI)**：`http://localhost/api/docs`
- **API 文档 (ReDoc)**：`http://localhost/api/redoc`

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L33)
- [deploy/web.conf](file://deploy/web.conf#L1-L13)