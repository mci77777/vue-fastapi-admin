# GymBro APP Supabaseæ•°æ®åº“è®¾ç½®æŒ‡å—

**ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025-09-29  
**é€‚ç”¨èŒƒå›´**: Supabase Dashboard SQL Editor

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†åœ¨Supabase Dashboardä¸­è®¾ç½®GymBro APPå®Œæ•´æ•°æ®åº“ç»“æ„çš„æ­¥éª¤ã€‚æ•°æ®åº“ç»“æ„åŸºäºAndroid Roomæ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…å«29ä¸ªè¡¨å’Œå®Œæ•´çš„RLSç­–ç•¥ã€‚

## ğŸ—‚ï¸ æ•°æ®åº“ç»“æ„æ¦‚è§ˆ

### æ ¸å¿ƒæ¨¡å—è¡¨
- **ç”¨æˆ·ç®¡ç†**: `users`, `user_profiles`, `user_settings`
- **èŠå¤©ç³»ç»Ÿ**: `chat_sessions`, `chat_raw`, `message_embedding`
- **è¿åŠ¨æ•°æ®**: `exercise`, `exercise_search_history`, `exercise_usage_stats`
- **è®­ç»ƒè®¡åˆ’**: `workout_plans`, `plan_days`, `plan_templates`
- **è®­ç»ƒä¼šè¯**: `workout_sessions`, `session_exercises`, `session_sets`
- **ç»Ÿè®¡æ•°æ®**: `daily_stats`, `exercise_history_stats`
- **æ¨¡æ¿ç³»ç»Ÿ**: `workout_templates`, `template_exercises`, `template_versions`

### æ”¯æŒåŠŸèƒ½è¡¨
- **æœç´¢**: `search_content`, `exercise_fts`, `chat_fts`
- **æ—¥å†**: `calendar_events`
- **ä»¤ç‰Œ**: `tokens`
- **å‘é‡æœç´¢**: `chat_vec`
- **ä¼šè¯æ‘˜è¦**: `session_summary`
- **è®°å¿†è®°å½•**: `memory_records`
- **è‡ªåŠ¨ä¿å­˜**: `session_autosave`

## ğŸš€ å¿«é€Ÿè®¾ç½®æ­¥éª¤

### æ­¥éª¤1ï¼šå‡†å¤‡Supabaseé¡¹ç›®
1. ç™»å½• [Supabase Dashboard](https://supabase.com/dashboard)
2. é€‰æ‹©æ‚¨çš„GymBroé¡¹ç›®
3. å¯¼èˆªåˆ° **SQL Editor**

### æ­¥éª¤2ï¼šæ‰§è¡Œæ•°æ®åº“ç»“æ„è„šæœ¬
```sql
-- åœ¨SQL Editorä¸­æ‰§è¡Œä»¥ä¸‹æ–‡ä»¶å†…å®¹
-- æ–‡ä»¶ä½ç½®: docs/jwtæ”¹é€ /GYMBRO_COMPLETE_SUPABASE_SCHEMA.sql
```

**é‡è¦æç¤º**:
- è„šæœ¬åŒ…å«1192è¡ŒSQLä»£ç 
- æ‰§è¡Œæ—¶é—´çº¦2-5åˆ†é’Ÿ
- å»ºè®®åˆ†æ®µæ‰§è¡Œä»¥é¿å…è¶…æ—¶

### æ­¥éª¤3ï¼šéªŒè¯è®¾ç½®ç»“æœ
æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢éªŒè¯è¡¨åˆ›å»ºï¼š
```sql
-- éªŒè¯æ‰€æœ‰è¡¨å·²åˆ›å»º
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- åº”è¯¥è¿”å›29ä¸ªè¡¨
```

## ğŸ” å®‰å…¨ç­–ç•¥è¯´æ˜

### RLSç­–ç•¥çŸ©é˜µ
| ç”¨æˆ·ç±»å‹ | æ•°æ®è®¿é—® | ç‰¹æ®Šé™åˆ¶ |
|----------|----------|----------|
| `authenticated` | ä»…è‡ªå·±æ•°æ® | åŸºäº `auth.uid()` |
| `anonymous` | ä»…è‡ªå·±æ•°æ® | ç¦æ­¢å…¬å¼€åˆ†äº« |
| `service_role` | å®Œå…¨è®¿é—® | åç«¯æœåŠ¡ä¸“ç”¨ |

### åŒ¿åç”¨æˆ·æ”¯æŒ
- âœ… æ”¯æŒåŒ¿åç”¨æˆ·åŸºæœ¬åŠŸèƒ½
- âŒ ç¦æ­¢åˆ›å»ºå…¬å¼€åˆ†äº«
- ğŸ—‘ï¸ 30å¤©è‡ªåŠ¨æ•°æ®æ¸…ç†
- ğŸ“Š å®¡è®¡å­—æ®µè¿½è¸ªç”¨æˆ·ç±»å‹

## ğŸ“Š å…³é”®ç‰¹æ€§

### 1. è‡ªåŠ¨UUIDç”Ÿæˆ
```sql
-- æ‰€æœ‰ä¸»é”®IDå­—æ®µè‡ªåŠ¨ç”ŸæˆUUID
id UUID DEFAULT gen_random_uuid() PRIMARY KEY
```

### 2. æ—¶é—´æˆ³ç®¡ç†
```sql
-- è‡ªåŠ¨è®¾ç½®åˆ›å»ºå’Œæ›´æ–°æ—¶é—´
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW()
```

### 3. JSONå­—æ®µæ”¯æŒ
```sql
-- è®¾ç½®å’Œé…ç½®ä½¿ç”¨JSONBç±»å‹
settingsJson JSONB,
fitnessGoalsJson JSONB,
metadata JSONB DEFAULT '{}'
```

### 4. å…¨æ–‡æœç´¢æ”¯æŒ
- `exercise_fts`: è¿åŠ¨å…¨æ–‡æœç´¢
- `chat_fts`: èŠå¤©å…¨æ–‡æœç´¢
- `search_content`: é€šç”¨æœç´¢å†…å®¹

### 5. å‘é‡æœç´¢æ”¯æŒ
- `chat_vec`: èŠå¤©å‘é‡å­˜å‚¨
- `message_embedding`: æ¶ˆæ¯åµŒå…¥å‘é‡
- `user_profiles.vector`: ç”¨æˆ·æ¡£æ¡ˆå‘é‡

## ğŸ”§ é«˜çº§é…ç½®

### å®šæ—¶æ•°æ®æ¸…ç†
```sql
-- è®¾ç½®æ¯æ—¥æ¸…ç†åŒ¿åç”¨æˆ·æ•°æ®ï¼ˆéœ€è¦pg_cronæ‰©å±•ï¼‰
SELECT cron.schedule('cleanup-anonymous-data', '0 2 * * *', 
    'SELECT cleanup_anonymous_user_data(30);');
```

### æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
è„šæœ¬è‡ªåŠ¨åˆ›å»ºä»¥ä¸‹ç´¢å¼•ï¼š
- ç”¨æˆ·IDç´¢å¼•ï¼ˆæ‰€æœ‰ç”¨æˆ·ç›¸å…³è¡¨ï¼‰
- æ—¶é—´æˆ³ç´¢å¼•ï¼ˆæ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼‰
- çŠ¶æ€å­—æ®µç´¢å¼•ï¼ˆæ”¯æŒçŠ¶æ€ç­›é€‰ï¼‰
- ç”¨æˆ·ç±»å‹å®¡è®¡ç´¢å¼•ï¼ˆæ”¯æŒåŒ¿åç”¨æˆ·åˆ†æï¼‰

## ğŸš¨ æ³¨æ„äº‹é¡¹

### æ‰§è¡Œå‰æ£€æŸ¥
- [ ] ç¡®è®¤Supabaseé¡¹ç›®å·²åˆ›å»º
- [ ] ç¡®è®¤æœ‰è¶³å¤Ÿçš„æ•°æ®åº“é…é¢
- [ ] å¤‡ä»½ç°æœ‰æ•°æ®ï¼ˆå¦‚æœ‰ï¼‰

### æ‰§è¡ŒæœŸé—´
- â±ï¸ è„šæœ¬æ‰§è¡Œéœ€è¦2-5åˆ†é’Ÿ
- ğŸ”„ å¦‚é‡è¶…æ—¶ï¼Œå¯åˆ†æ®µæ‰§è¡Œ
- ğŸ“ æ³¨æ„è§‚å¯Ÿæ‰§è¡Œæ—¥å¿—

### æ‰§è¡ŒåéªŒè¯
- [ ] éªŒè¯29ä¸ªè¡¨å·²åˆ›å»º
- [ ] éªŒè¯RLSç­–ç•¥å·²å¯ç”¨
- [ ] éªŒè¯ç´¢å¼•å·²åˆ›å»º
- [ ] æµ‹è¯•åŸºæœ¬CRUDæ“ä½œ

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ‰©å±•æœªå¯ç”¨
**é”™è¯¯**: `extension "uuid-ossp" does not exist`
**è§£å†³**: åœ¨SQL Editorä¸­æ‰§è¡Œï¼š
```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

#### 2. æƒé™ä¸è¶³
**é”™è¯¯**: `permission denied for schema public`
**è§£å†³**: ç¡®è®¤ä½¿ç”¨service_roleå¯†é’¥æ‰§è¡Œ

#### 3. è¡¨å·²å­˜åœ¨
**é”™è¯¯**: `relation "users" already exists`
**è§£å†³**: è„šæœ¬ä½¿ç”¨`IF NOT EXISTS`ï¼Œå¯å®‰å…¨é‡å¤æ‰§è¡Œ

#### 4. è¶…æ—¶é”™è¯¯
**é”™è¯¯**: `Query timeout`
**è§£å†³**: åˆ†æ®µæ‰§è¡Œè„šæœ¬ï¼Œæ¯æ¬¡æ‰§è¡Œ100-200è¡Œ

### åˆ†æ®µæ‰§è¡Œå»ºè®®
å¦‚é‡è¶…æ—¶ï¼Œå¯æŒ‰ä»¥ä¸‹é¡ºåºåˆ†æ®µæ‰§è¡Œï¼š

1. **æ‰©å±•å’ŒåŸºç¡€è¡¨** (ç¬¬1-400è¡Œ)
2. **ç´¢å¼•åˆ›å»º** (ç¬¬401-600è¡Œ)
3. **å¤–é”®çº¦æŸ** (ç¬¬601-700è¡Œ)
4. **RLSç­–ç•¥** (ç¬¬701-1000è¡Œ)
5. **åŒ¿åç”¨æˆ·æ”¯æŒ** (ç¬¬1001-1192è¡Œ)

## ğŸ“ æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Supabaseé¡¹ç›®çŠ¶æ€
2. æ•°æ®åº“é…é¢ä½¿ç”¨æƒ…å†µ
3. SQLè¯­æ³•é”™è¯¯æ—¥å¿—
4. ç½‘ç»œè¿æ¥çŠ¶æ€

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabase RLSæ–‡æ¡£](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQLæ•°æ®ç±»å‹](https://www.postgresql.org/docs/current/datatype.html)
- [GymBroåŒ¿åç”¨æˆ·å®ç°æŠ¥å‘Š](./ANON_IMPLEMENTATION_FINAL_REPORT.md)

---

**é‡è¦æé†’**: æ‰§è¡ŒSQLè„šæœ¬å‰è¯·ç¡®ä¿ç†è§£å…¶å½±å“ï¼Œå»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­å…ˆè¡ŒéªŒè¯ã€‚
