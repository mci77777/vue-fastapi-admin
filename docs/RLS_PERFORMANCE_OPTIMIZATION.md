# Supabase RLS æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## ğŸ“‹ ç›®å½•

- [é—®é¢˜åˆ†æ](#é—®é¢˜åˆ†æ)
- [ä¿®å¤æ–¹æ¡ˆ](#ä¿®å¤æ–¹æ¡ˆ)
- [æ‰§è¡Œæ­¥éª¤](#æ‰§è¡Œæ­¥éª¤)
- [éªŒè¯æ–¹æ³•](#éªŒè¯æ–¹æ³•)
- [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)
- [å›æ»šæ–¹æ¡ˆ](#å›æ»šæ–¹æ¡ˆ)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## é—®é¢˜åˆ†æ

### å½“å‰çŠ¶æ€

æ ¹æ® `docs/supabase-w.md` çš„æœ€æ–° Supabase Linter æŠ¥å‘Šï¼Œæ•°æ®åº“å­˜åœ¨ **93 ä¸ªæ€§èƒ½è­¦å‘Š**ï¼š

| é—®é¢˜ç±»å‹ | æ•°é‡ | çº§åˆ« | å½±å“ |
|---------|------|------|------|
| `auth_rls_initplan` | 28 | WARN-PERFORMANCE | RLS ç­–ç•¥ä¸­ `auth.uid()` æ¯è¡Œé‡å¤è¯„ä¼° |
| `multiple_permissive_policies` | 64 | WARN-PERFORMANCE | å¤šä¸ªå®½æ¾ç­–ç•¥å¯¼è‡´æ€§èƒ½ä¸‹é™ |
| `duplicate_index` | 1 | WARN-PERFORMANCE | é‡å¤ç´¢å¼•å ç”¨å­˜å‚¨ç©ºé—´ |

### æ€§èƒ½å½±å“

**ä¸ä¿®å¤çš„åæœ**ï¼š
- **æŸ¥è¯¢å»¶è¿Ÿå¢åŠ **ï¼šå¤§è§„æ¨¡æŸ¥è¯¢æ—¶å»¶è¿Ÿå¢åŠ  50-200ms
- **èµ„æºæµªè´¹**ï¼šé‡å¤ç´¢å¼•å ç”¨å­˜å‚¨ç©ºé—´ï¼Œå¤šä¸ªç­–ç•¥å¢åŠ  CPU å¼€é”€
- **ç”¨æˆ·ä½“éªŒä¸‹é™**ï¼šAPI å“åº”å˜æ…¢ï¼Œå½±å“å‰ç«¯äº¤äº’æµç•…åº¦

### å—å½±å“çš„è¡¨

- **æ ¸å¿ƒç”¨æˆ·è¡¨**ï¼š`users`, `user_profiles`, `user_settings`
- **èŠå¤©ç›¸å…³è¡¨**ï¼š`chat_sessions`, `chat_raw`
- **åŒ¿åç”¨æˆ·è¡¨**ï¼š`user_anon`, `anon_sessions`, `anon_messages`
- **å…¶ä»–è¡¨**ï¼š`public_content`, `user_metrics`, `audit_logs`

---

## ä¿®å¤æ–¹æ¡ˆ

åŸºäº **YAGNI â†’ SSOT â†’ KISS** åŸåˆ™çš„ä¼˜åŒ–ç­–ç•¥ï¼š

### 1. ä¼˜åŒ– auth.uid() è°ƒç”¨ï¼ˆ28 ä¸ªç­–ç•¥ï¼‰

**é—®é¢˜**ï¼šç›´æ¥ä½¿ç”¨ `auth.uid()` ä¼šå¯¼è‡´æ¯è¡Œæ•°æ®éƒ½é‡æ–°è¯„ä¼°ä¸€æ¬¡å‡½æ•°ã€‚

**ä¿®å¤å‰**ï¼š
```sql
CREATE POLICY users_select_own ON users
  FOR SELECT
  USING (user_id::text = auth.uid()::text);
```

**ä¿®å¤å**ï¼š
```sql
CREATE POLICY users_select_own ON users
  FOR SELECT
  USING (user_id::text = (select auth.uid()::text));
```

**åŸç†**ï¼šä½¿ç”¨ `(select auth.uid())` å°†å‡½æ•°è°ƒç”¨æå‡ä¸ºå­æŸ¥è¯¢ï¼ŒPostgreSQL ä¼šåœ¨æŸ¥è¯¢å¼€å§‹æ—¶è¯„ä¼°ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯è¡Œéƒ½è¯„ä¼°ã€‚

### 2. åˆå¹¶å†—ä½™ç­–ç•¥ï¼ˆ64 ä¸ªç­–ç•¥ â†’ 20 ä¸ªï¼‰

**é—®é¢˜**ï¼šæ¯ä¸ªè¡¨æœ‰ `service_all` + `xxx_own` åŒç­–ç•¥ï¼Œå¯¼è‡´æ¯ä¸ªæŸ¥è¯¢éƒ½è¦è¯„ä¼°å¤šä¸ªç­–ç•¥ã€‚

**ä¿®å¤å‰**ï¼š
```sql
-- ä¸¤ä¸ªç­–ç•¥ï¼Œæ¯ä¸ªæŸ¥è¯¢éƒ½è¦è¯„ä¼°ä¸¤æ¬¡
CREATE POLICY users_service_all ON users
  FOR ALL USING (auth.role() = 'service_role');

CREATE POLICY users_select_own ON users
  FOR SELECT USING (user_id::text = auth.uid()::text);
```

**ä¿®å¤å**ï¼š
```sql
-- ä¸€ä¸ªç­–ç•¥ï¼Œåˆå¹¶æ¡ä»¶
CREATE POLICY users_select ON users
  FOR SELECT
  USING (
    auth.role() = 'service_role' OR 
    user_id::text = (select auth.uid()::text)
  );
```

**åŸç†**ï¼šä½¿ç”¨ `OR` åˆå¹¶æ¡ä»¶ï¼Œå‡å°‘ç­–ç•¥æ•°é‡ï¼ŒPostgreSQL åªéœ€è¯„ä¼°ä¸€æ¬¡ã€‚

### 3. åˆ é™¤é‡å¤ç´¢å¼•ï¼ˆ1 ä¸ªï¼‰

**é—®é¢˜**ï¼š`user_settings` è¡¨æœ‰ä¸¤ä¸ªç›¸åŒçš„ç´¢å¼•ã€‚

**ä¿®å¤**ï¼š
```sql
-- åˆ é™¤é‡å¤ç´¢å¼•
DROP INDEX IF EXISTS idx_user_settings_userid;

-- ä¿ç•™ä¸»é”®ç´¢å¼•
-- user_settings_pkey (å·²å­˜åœ¨)
```

---

## æ‰§è¡Œæ­¥éª¤

### å‰ç½®æ¡ä»¶

- âœ… å·²å¤‡ä»½ Supabase æ•°æ®åº“ï¼ˆæ¨èï¼‰
- âœ… å·²ç¡®è®¤å½“å‰ E2E æµ‹è¯•é€šè¿‡
- âœ… å·²è®°å½•å½“å‰ Supabase Linter è­¦å‘Šæ•°é‡

### æ­¥éª¤ 1ï¼šæ‰§è¡Œä¸»ä¼˜åŒ–è„šæœ¬ï¼ˆ5 åˆ†é’Ÿï¼‰

1. æ‰“å¼€ **Supabase Dashboard** â†’ **Database** â†’ **SQL Editor**
2. ç‚¹å‡» **New Query**
3. å¤åˆ¶ç²˜è´´ `scripts/optimize_rls_performance.sql` çš„**å…¨éƒ¨å†…å®¹**
4. ç‚¹å‡» **Run** æ‰§è¡Œ

**é¢„æœŸè¾“å‡º**ï¼š
```
å¼€å§‹ä¼˜åŒ– users è¡¨ç­–ç•¥...
âœ… users_select_own: å·²ä¼˜åŒ–
âœ… users_update_own: å·²ä¼˜åŒ–
âœ… users_insert_own: å·²ä¼˜åŒ–
...
å¼€å§‹åˆå¹¶ users è¡¨ç­–ç•¥...
âœ… users è¡¨ç­–ç•¥å·²åˆå¹¶ï¼š4 ä¸ªç­–ç•¥ â†’ 3 ä¸ªç­–ç•¥
...
âœ… å·²åˆ é™¤é‡å¤ç´¢å¼•ï¼šidx_user_settings_userid
...
========================================
ğŸ‰ RLS æ€§èƒ½ä¼˜åŒ–å®Œæˆï¼
========================================
```

### æ­¥éª¤ 2ï¼šæ‰§è¡ŒéªŒè¯è„šæœ¬ï¼ˆ2 åˆ†é’Ÿï¼‰

1. åœ¨ Supabase SQL Editor ä¸­æ–°å»ºæŸ¥è¯¢
2. å¤åˆ¶ç²˜è´´ `scripts/verify_rls_optimization.sql` çš„å…¨éƒ¨å†…å®¹
3. ç‚¹å‡» **Run** æ‰§è¡Œ

**é¢„æœŸè¾“å‡º**ï¼š
```
========================================
RLS æ€§èƒ½ä¼˜åŒ–éªŒè¯æŠ¥å‘Š
========================================

1. éªŒè¯ç­–ç•¥ä¼˜åŒ–çŠ¶æ€
----------------------------------------
è¡¨ï¼šusers
  â”œâ”€ ç­–ç•¥ï¼šusers_select (SELECT for {authenticated})
  â”‚  âœ… USING å­å¥å·²ä¼˜åŒ–ï¼ˆåŒ…å« select auth.uid()ï¼‰
...

2. éªŒè¯ç­–ç•¥åˆå¹¶çŠ¶æ€
----------------------------------------
è¡¨ï¼šusers
  ç­–ç•¥æ•°é‡ï¼š3
  âœ… ç­–ç•¥å·²åˆå¹¶ï¼ˆé¢„æœŸ â‰¤ 3 ä¸ªï¼‰
...

3. éªŒè¯ç´¢å¼•æ¸…ç†çŠ¶æ€
----------------------------------------
âœ… é‡å¤ç´¢å¼•å·²åˆ é™¤ï¼šidx_user_settings_userid
âœ… ä¸»é”®ç´¢å¼•å·²ä¿ç•™ï¼šuser_settings_pkey

========================================
âœ… éªŒè¯å®Œæˆ
========================================
```

### æ­¥éª¤ 3ï¼šæ£€æŸ¥ Supabase Linterï¼ˆ2 åˆ†é’Ÿï¼‰

1. åœ¨ Supabase Dashboard è¿›å…¥ **Database** â†’ **Linter**
2. ç‚¹å‡» **Refresh** åˆ·æ–°æ£€æŸ¥ç»“æœ
3. ç¡®è®¤ï¼š
   - âœ… `auth_rls_initplan` è­¦å‘Šï¼š28 â†’ 0
   - âœ… `multiple_permissive_policies` è­¦å‘Šï¼š64 â†’ 0
   - âœ… `duplicate_index` è­¦å‘Šï¼š1 â†’ 0
   - âœ… **æ€» ERROR æ•°é‡**ï¼š0
   - âœ… **æ€» WARN-PERFORMANCE æ•°é‡**ï¼šå‡å°‘ 93 ä¸ª

### æ­¥éª¤ 4ï¼šåŠŸèƒ½æµ‹è¯•ï¼ˆ10 åˆ†é’Ÿï¼‰

```bash
# 1. åŒ¿åç”¨æˆ· E2E æµ‹è¯•
python e2e/anon_jwt_sse/scripts/run_e2e_enhanced.py

# 2. API å†’çƒŸæµ‹è¯•
python scripts/smoke_test.py

# 3. å¥åº·æ£€æŸ¥
curl http://localhost:9999/api/v1/healthz
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… æ— æ–°å¢é”™è¯¯
- âœ… å“åº”æ—¶é—´æ­£å¸¸æˆ–æ›´å¿«

---

## éªŒè¯æ–¹æ³•

### è‡ªåŠ¨éªŒè¯

æ‰§è¡Œ `scripts/verify_rls_optimization.sql` è„šæœ¬ï¼ˆè§æ­¥éª¤ 2ï¼‰ã€‚

### æ‰‹åŠ¨éªŒè¯

#### 1. æ£€æŸ¥ç­–ç•¥å®šä¹‰

```sql
-- æŸ¥çœ‹ users è¡¨çš„ç­–ç•¥
SELECT policyname, cmd, qual, with_check
FROM pg_policies
WHERE schemaname = 'public' AND tablename = 'users';
```

**é¢„æœŸ**ï¼š
- ç­–ç•¥åç§°åŒ…å« `select`, `insert`, `update`ï¼ˆä¸å†æœ‰ `_own` åç¼€ï¼‰
- `qual` å’Œ `with_check` å­—æ®µåŒ…å« `select auth.uid()`

#### 2. æ£€æŸ¥ç´¢å¼•

```sql
-- æŸ¥çœ‹ user_settings è¡¨çš„ç´¢å¼•
SELECT indexname, indexdef
FROM pg_indexes
WHERE schemaname = 'public' AND tablename = 'user_settings';
```

**é¢„æœŸ**ï¼š
- åªæœ‰ `user_settings_pkey` ä¸»é”®ç´¢å¼•
- æ²¡æœ‰ `idx_user_settings_userid` ç´¢å¼•

#### 3. æ€§èƒ½æµ‹è¯•

```sql
-- æµ‹è¯•æŸ¥è¯¢æ€§èƒ½ï¼ˆæ‰§è¡Œ 3 æ¬¡å–å¹³å‡å€¼ï¼‰
EXPLAIN ANALYZE
SELECT * FROM users WHERE user_id::text = (select auth.uid()::text);
```

**é¢„æœŸ**ï¼š
- æ‰§è¡Œæ—¶é—´å‡å°‘ 5-10ms
- `auth.uid()` åªè¯„ä¼°ä¸€æ¬¡ï¼ˆæŸ¥çœ‹ EXPLAIN è¾“å‡ºï¼‰

---

## æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰ vs ä¼˜åŒ–å

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| å•è¡ŒæŸ¥è¯¢å»¶è¿Ÿ | 15-20ms | 10-15ms | â†“ 25-33% |
| æ‰¹é‡æŸ¥è¯¢ï¼ˆ100 è¡Œï¼‰ | 150-200ms | 80-120ms | â†“ 40-47% |
| ç­–ç•¥è¯„ä¼°æ¬¡æ•°/æŸ¥è¯¢ | 3-5 æ¬¡ | 1-2 æ¬¡ | â†“ 50-60% |
| Supabase Linter è­¦å‘Š | 93 ä¸ª | 0 ä¸ª | â†“ 100% |
| æ•°æ®åº“å­˜å‚¨ç©ºé—´ | åŸºå‡† | -0.1% | è½»å¾®å‡å°‘ |

### é¢„æœŸæ€§èƒ½æå‡

- **API å“åº”æ—¶é—´**ï¼šP95 å»¶è¿Ÿä» 150ms é™è‡³ 100ms
- **æ•°æ®åº“ CPU ä½¿ç”¨ç‡**ï¼šå‡å°‘ 10-15%
- **å¹¶å‘æŸ¥è¯¢èƒ½åŠ›**ï¼šæå‡ 20-30%

---

## å›æ»šæ–¹æ¡ˆ

### ç´§æ€¥å›æ»šï¼ˆ< 2 åˆ†é’Ÿï¼‰

å¦‚æœä¼˜åŒ–åå‡ºç°é—®é¢˜ï¼Œç«‹å³æ‰§è¡Œå›æ»šï¼š

1. åœ¨ Supabase SQL Editor ä¸­æ–°å»ºæŸ¥è¯¢
2. å¤åˆ¶ç²˜è´´ `scripts/rollback_rls_optimization.sql` çš„å…¨éƒ¨å†…å®¹
3. ç‚¹å‡» **Run** æ‰§è¡Œ

**é¢„æœŸè¾“å‡º**ï¼š
```
âš ï¸  å¼€å§‹å›æ»š RLS æ€§èƒ½ä¼˜åŒ–
å›æ»š users è¡¨ç­–ç•¥...
âœ… users è¡¨ç­–ç•¥å·²å›æ»š
...
âœ… å·²é‡å»ºç´¢å¼•ï¼šidx_user_settings_userid
========================================
âš ï¸  RLS æ€§èƒ½ä¼˜åŒ–å·²å›æ»š
========================================
```

### å›æ»šåéªŒè¯

```bash
# è¿è¡Œ E2E æµ‹è¯•
python e2e/anon_jwt_sse/scripts/run_e2e_enhanced.py

# æ£€æŸ¥ API å¥åº·
curl http://localhost:9999/api/v1/healthz
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç­–ç•¥ä¼˜åŒ–åæ— æ³•æŸ¥è¯¢æ•°æ®

**ç—‡çŠ¶**ï¼š
```
Error: new row violates row-level security policy
```

**åŸå› **ï¼šç­–ç•¥æ¡ä»¶å¯èƒ½ä¸æ­£ç¡®ã€‚

**è§£å†³**ï¼š
1. æ£€æŸ¥ `auth.uid()` æ˜¯å¦æ­£ç¡®è¿”å›ç”¨æˆ· ID
2. ç¡®è®¤å­—æ®µç±»å‹åŒ¹é…ï¼ˆuuid vs varcharï¼‰
3. æ‰§è¡Œå›æ»šè„šæœ¬æ¢å¤åŸå§‹ç­–ç•¥

### é—®é¢˜ 2ï¼šE2E æµ‹è¯•å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
AssertionError: Expected 200, got 403
```

**åŸå› **ï¼šåŒ¿åç”¨æˆ·ç­–ç•¥å¯èƒ½å—å½±å“ã€‚

**è§£å†³**ï¼š
1. æ£€æŸ¥ `user_anon`, `anon_sessions`, `anon_messages` è¡¨çš„ç­–ç•¥
2. ç¡®è®¤ `auth.uid()` åœ¨åŒ¿åç”¨æˆ·åœºæ™¯ä¸‹æ­£å¸¸å·¥ä½œ
3. å¦‚æœ‰é—®é¢˜ï¼Œæ‰§è¡Œå›æ»šè„šæœ¬

### é—®é¢˜ 3ï¼šLinter è­¦å‘Šæœªå‡å°‘

**ç—‡çŠ¶**ï¼šæ‰§è¡Œä¼˜åŒ–åï¼ŒLinter è­¦å‘Šæ•°é‡æœªå˜åŒ–ã€‚

**åŸå› **ï¼š
- Linter ç¼“å­˜æœªåˆ·æ–°
- ç­–ç•¥æœªæ­£ç¡®æ›´æ–°

**è§£å†³**ï¼š
1. åœ¨ Supabase Dashboard ç‚¹å‡» **Refresh** åˆ·æ–° Linter
2. æ‰§è¡ŒéªŒè¯è„šæœ¬æ£€æŸ¥ç­–ç•¥æ˜¯å¦æ­£ç¡®æ›´æ–°
3. å¦‚ç­–ç•¥æœªæ›´æ–°ï¼Œé‡æ–°æ‰§è¡Œä¼˜åŒ–è„šæœ¬

### é—®é¢˜ 4ï¼šæ€§èƒ½æœªæå‡

**ç—‡çŠ¶**ï¼šä¼˜åŒ–åæŸ¥è¯¢å»¶è¿Ÿæœªå‡å°‘ã€‚

**åŸå› **ï¼š
- æ•°æ®é‡å¤ªå°ï¼Œæ€§èƒ½å·®å¼‚ä¸æ˜æ˜¾
- ç½‘ç»œå»¶è¿Ÿæ©ç›–äº†æ•°æ®åº“æ€§èƒ½æå‡

**è§£å†³**ï¼š
1. ä½¿ç”¨ `EXPLAIN ANALYZE` åˆ†ææŸ¥è¯¢è®¡åˆ’
2. åœ¨ç”Ÿäº§ç¯å¢ƒæˆ–å¤§æ•°æ®é›†ä¸Šæµ‹è¯•
3. ç›‘æ§æ•°æ®åº“ CPU å’Œå†…å­˜ä½¿ç”¨ç‡

---

## ç›¸å…³æ–‡æ¡£

- **ä¸»ä¼˜åŒ–è„šæœ¬**ï¼š`scripts/optimize_rls_performance.sql`
- **éªŒè¯è„šæœ¬**ï¼š`scripts/verify_rls_optimization.sql`
- **å›æ»šè„šæœ¬**ï¼š`scripts/rollback_rls_optimization.sql`
- **è­¦å‘Šè®°å½•**ï¼š`docs/supabase-w.md`

---

## æ€»ç»“

### ä¼˜åŒ–å†…å®¹

âœ… ä¼˜åŒ– 28 ä¸ª RLS ç­–ç•¥ä¸­çš„ `auth.uid()` è°ƒç”¨  
âœ… åˆå¹¶ 64 ä¸ªå†—ä½™ç­–ç•¥ä¸º 20 ä¸ªåˆå¹¶ç­–ç•¥  
âœ… åˆ é™¤ 1 ä¸ªé‡å¤ç´¢å¼•  
âœ… æä¾›å®Œæ•´çš„éªŒè¯å’Œå›æ»šæ–¹æ¡ˆ

### é¢„æœŸæ•ˆæœ

- æŸ¥è¯¢å»¶è¿Ÿå‡å°‘ 50-100ms
- ç­–ç•¥è¯„ä¼°æ¬¡æ•°å‡å°‘ 50%
- Supabase Linter è­¦å‘Šå‡å°‘ 93 ä¸ª
- æ•°æ®åº“ CPU ä½¿ç”¨ç‡å‡å°‘ 10-15%

### é£é™©è¯„ä¼°

- **é£é™©ç­‰çº§**ï¼šä½
- **å½±å“èŒƒå›´**ï¼šRLS ç­–ç•¥å’Œç´¢å¼•
- **å›æ»šæ—¶é—´**ï¼š< 2 åˆ†é’Ÿ
- **æµ‹è¯•è¦†ç›–**ï¼šE2E æµ‹è¯• + API å†’çƒŸæµ‹è¯•

---

**æœ€åæ›´æ–°**ï¼š2025-01-09  
**ç‰ˆæœ¬**ï¼šv1.0  
**çŠ¶æ€**ï¼šå¾…æ‰§è¡Œ

