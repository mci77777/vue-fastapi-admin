# GymBro AI Endpoint Feature Plan

## èƒŒæ™¯ä¸ç›®æ ‡
- é€šè¿‡ FastAPI æ‰“é€ ç»Ÿä¸€çš„ LLM ä»£ç†å±‚ï¼Œè¿æ¥ç§»åŠ¨ç«¯ App ä¸å¯é…ç½®çš„ OpenAI å…¼å®¹æ¨¡å‹ã€‚
- ç¡®ä¿ Promptã€å·¥å…·æè¿°ã€æ¨¡å‹åˆ—è¡¨å¯ç”±åå°å®‰å…¨ç»´æŠ¤ï¼ŒApp ä¾§ä»…éœ€æºå¸¦ JWT ä¸ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚
- éµå¾ª YAGNI / KISS / DRY åŸåˆ™ï¼Œå…ˆäº¤ä»˜ç¨³å®š MVPï¼Œå†é€æ­¥å¢å¼ºåŠŸèƒ½ã€‚

## åˆ©ç›Šç›¸å…³æ–¹
- äº§å“ï¼šGymBro æ ¸å¿ƒä½“éªŒå°ç»„ã€‚
- åç«¯ï¼šFastAPI + Tortoise ORM å›¢é˜Ÿã€‚
- å‰ç«¯ï¼šVue ç®¡ç†åå°ã€ç§»åŠ¨ç«¯ MVI å›¢é˜Ÿã€‚
- è¿è¥ä¸å®¢æœï¼šç›‘æ§ AI è¡Œä¸ºä¸ç”¨æˆ·åé¦ˆã€‚

## æˆåŠŸæŒ‡æ ‡ï¼ˆDONEï¼‰
1. `/api/v1/llm/chat` åœ¨å¯ç”¨ JWT çš„æƒ…å†µä¸‹å¯æˆåŠŸè°ƒç”¨æŒ‡å®šæ¨¡å‹å¹¶è¿”å›å“åº”ã€‚
2. åå°å¯æŸ¥çœ‹ã€ç¼–è¾‘å¹¶åˆ‡æ¢æ´»è·ƒ Promptï¼Œæä¾›æµ‹è¯•åŠŸèƒ½ã€‚
3. App å¯é€šè¿‡ `/api/v1/llm/models` æ‹‰å–æ¨¡å‹åˆ—è¡¨ï¼Œé€‰æ‹©åæˆåŠŸå‘èµ·å¯¹è¯ã€‚
4. å•å…ƒæµ‹è¯•è¦†ç›–æˆåŠŸ/å¤±è´¥/ç¼ºé…ç½®è·¯å¾„ï¼›å®¡è®¡æ—¥å¿—è®°å½•åŸºæœ¬è°ƒç”¨ä¿¡æ¯ã€‚
5. 2025-10 update: delivered SQLite + Supabase dual storage, status checks, prompt testing & admin UI (see `implementation.md`).

## æ¶æ„æ¦‚è¦
- App â†’ FastAPI (`/api/v1/llm/chat`) â†’ å¯é…ç½® LLM Endpointã€‚
- PromptBuilderï¼šç»„åˆç³»ç»Ÿ Promptã€å·¥å…·åˆ—è¡¨ã€ç”¨æˆ·ä¸Šä¸‹æ–‡ã€App ä¼ å…¥çš„æ¶ˆæ¯ã€‚
- LLMClientï¼šåŸºäº `httpx.AsyncClient` çš„è½»é‡å°è£…ï¼Œæ”¯æŒ base_url/api_key/model è¦†å†™ã€‚
- é…ç½®å­˜å‚¨ï¼šç¯å¢ƒå˜é‡å…œåº• + æ•°æ®åº“ `ai_prompt`ã€`ai_model` è¡¨ï¼Œåå°ç®¡ç†é¡µé¢ç»´æŠ¤ã€‚

## Prompt ç®¡ç†æ¨¡å‹
- `ai_prompt` è¡¨å­—æ®µï¼š`id`ã€`name`ã€`version`ã€`system_prompt`ã€`tools_json`ã€`description`ã€`is_active`ã€`updated_at`ã€`updated_by`ã€‚
- åå°ç•Œé¢ï¼šåˆ—è¡¨ã€è¯¦æƒ…ã€ç¼–è¾‘ã€æ¿€æ´»ã€æµ‹è¯•ï¼›ä»…è¶…çº§ç®¡ç†å‘˜å¯æ›´æ”¹ã€‚
- é»˜è®¤å¯¼å…¥ `docs/prompts/standard.json` å†…å®¹ï¼Œä¿ç•™ç‰ˆæœ¬å›æ»šèƒ½åŠ›ã€‚

## æ•°æ®ä¸Šä¸‹æ–‡æ‹¼è£…
- App å‘é€ `userInfo`ï¼ˆæœ¬åœ°æ±‡æ€»ï¼‰+ `messages`ï¼ˆå«å†å²å¯¹è¯ï¼‰ã€‚
- æœåŠ¡ç«¯è¡¥å……ï¼š
  - ç”¨æˆ·æ¦‚è§ˆï¼š`users`ã€`user_profiles`ã€`user_settings`ã€‚
  - è®­ç»ƒè®¡åˆ’ï¼š`workout_plans`ã€`plan_days`ã€`workout_templates`ã€`template_exercises`ã€‚
  - è¿‘æœŸè®­ç»ƒï¼š`workout_sessions`ã€`session_sets`ã€`exercise_history_stats`ã€`daily_stats`ã€‚
  - åŠ¨ä½œæ¨èï¼š`exercise`ã€`exercise_usage_stats`ã€`exercise_fts`ã€‚
- PromptBuilder æ ¹æ®è¯·æ±‚æ„å›¾è£å‰ªä¸Šä¸‹æ–‡ Sectionï¼Œé˜²æ­¢è¶…é•¿è¾“å‡ºã€‚

## å¼€å‘é˜¶æ®µä¸ä»»åŠ¡
### Phase 0 Â· å‡†å¤‡
1. å»ºç«‹ `docs/features/ai_endpoint/` æ–‡æ¡£ç»“æ„ï¼ˆå·²å®Œæˆï¼‰ã€‚
2. è¡¥å…… `.env.example` ä¸­çš„ `OPENAI_*` å­—æ®µè¯´æ˜ã€‚
3. è¯„ä¼°ç°æœ‰æƒé™ä½“ç³»ä¸å®¡è®¡æ—¥å¿—å®ç°ï¼Œç¡®è®¤å¤ç”¨æ–¹æ¡ˆã€‚

### Phase 1 Â· é…ç½®ä¸æ¨¡å‹ç®¡ç†
1. `app/settings/config.py` æ–°å¢ LLM ç›¸å…³é…ç½®ï¼ˆbase_urlã€api_keyã€modelã€timeoutã€prompt_pathï¼‰ã€‚
2. åˆ›å»ºæ•°æ®è¿ç§»ï¼š`ai_prompt`ã€`ai_model` è¡¨ã€‚
3. ç¼–å†™åˆå§‹æ•°æ®å¯¼å…¥è„šæœ¬ï¼Œä» `docs/prompts/standard.json` å†™å…¥é»˜è®¤è®°å½•ã€‚
4. å®ç° `/api/v1/llm/models`ï¼ˆGET/POST/PUTï¼‰æ¥å£ï¼Œé™åˆ¶ç®¡ç†å‘˜æ“ä½œã€‚
5. ç®¡ç†åå°æ–°å¢â€œAI é…ç½®â€é¡µé¢ï¼Œæ”¯æŒæ¨¡å‹åˆ—è¡¨ç»´æŠ¤ä¸å¯†é’¥é®æŒ¡æ˜¾ç¤ºã€‚

### Phase 2 Â· Prompt ç®¡ç†æ¥å£
1. å®ç° Prompt CRUD APIï¼š`GET /prompts`ã€`GET /prompts/{id}`ã€`POST`ã€`PUT`ã€`POST /{id}/activate`ã€‚
2. å¼•å…¥å®¡è®¡æ—¥å¿—è®°å½• Prompt çš„æ–°å¢/ç¼–è¾‘/æ¿€æ´»æ“ä½œã€‚
3. ç®¡ç†åå°å¢åŠ  Prompt åˆ—è¡¨ã€ç¼–è¾‘å™¨ã€æ¿€æ´»æŒ‰é’®ä¸â€œæµ‹è¯• Promptâ€åŠŸèƒ½ã€‚
4. ç¼–å†™å•å…ƒæµ‹è¯•è¦†ç›– Prompt API æƒé™ä¸æ•°æ®æ ¡éªŒã€‚

### Phase 3 Â· æ ¸å¿ƒèŠå¤©é“¾è·¯
1. æ–°å»º `app/services/llm_client.py`ï¼ˆ`async chat_completion()`ï¼‰ã€‚
2. æ–°å»º `app/services/prompt_builder.py`ï¼šåˆæˆç³»ç»Ÿ Promptã€å·¥å…·åˆ—è¡¨ã€ä¸Šä¸‹æ–‡ã€‚
3. æ–°å»º `app/schemas/llm.py`ï¼š`ChatMessage`ã€`ChatRequest`ã€`ChatResponse`ã€`PromptOverride` ç­‰ã€‚
4. åˆ›å»º `app/api/v1/llm/chat.py` è·¯ç”±ï¼š
   - å¼•å…¥ `DependAuth`ã€‚
   - æ”¯æŒè¯·æ±‚ä½“ä¸­çš„ `promptId`ã€`model`ã€`temperature`ã€`overrideConfig`ã€‚
   - ç»“åˆ PromptBuilder å’Œ LLMClient å®Œæˆè°ƒç”¨ã€‚
5. åœ¨ API æ³¨å†Œä¸æƒé™è¡¨ä¸­æ·»åŠ  `POST /api/v1/llm/chat`ï¼Œç¡®ä¿è§’è‰²å¯é…ç½®è®¿é—®ã€‚
6. è®°å½•è°ƒç”¨æ—¥å¿—ï¼ˆç”¨æˆ·ã€æ¨¡å‹ã€è€—æ—¶ã€çŠ¶æ€ç ï¼‰ï¼Œç”¨äºåç»­ç›‘æ§ã€‚

### Phase 4 Â· è”è°ƒä¸æµ‹è¯•
1. ä½¿ç”¨ `respx`/`pytest` Mock OpenAI ç«¯ç‚¹ï¼Œè¦†ç›–æˆåŠŸã€é…ç½®ç¼ºå¤±ã€ä¸Šæ¸¸é”™è¯¯ã€æƒé™ä¸è¶³ã€‚
2. ç®¡ç†åå°ç«¯åˆ°ç«¯æµ‹è¯•ï¼šç¼–è¾‘ Prompt â†’ æ¿€æ´» â†’ æµ‹è¯•è°ƒç”¨æˆåŠŸã€‚
3. ç§»åŠ¨ç«¯è”è°ƒï¼šéªŒè¯ JWT Headerã€`userInfo` ç»“æ„ã€æ¨¡å‹é€‰æ‹©ä¸å“åº”æ¸²æŸ“ã€‚
4. æ ¹æ® Strict XML è¾“å‡ºè§„èŒƒï¼Œå¢åŠ æœåŠ¡å™¨ç«¯å“åº”æ ¡éªŒï¼ˆå¼‚å¸¸æ—¶è¿”å›å‹å¥½é”™è¯¯æç¤ºï¼‰ã€‚

### Phase 5 Â· æ–‡æ¡£ä¸ä¸Šçº¿
1. ç¼–å†™ `docs/features/ai_endpoint/implementation.md`ï¼ˆåç»­è¡¥å……ï¼‰ï¼šæ¥å£å¥‘çº¦ã€æ ·ä¾‹è¯·æ±‚ã€é”™è¯¯ç ã€‚
2. æ›´æ–° README / éƒ¨ç½²æ–‡æ¡£ï¼Œè¯´æ˜ LLM é…ç½®ã€æƒé™ã€æ—¥å¿—ã€‚
3. åˆ¶å®šç›‘æ§ä¸é€Ÿç‡é™åˆ¶æ–¹æ¡ˆï¼Œçº³å…¥è¿è¥æ‰‹å†Œã€‚

## äº¤ä»˜ç‰©åˆ—è¡¨
- FastAPI æ–°è·¯ç”±ä¸æœåŠ¡å®ç°ä»£ç ã€‚
- Prompt & æ¨¡å‹ç®¡ç†æ•°æ®åº“è¿ç§»åŠåå°ç•Œé¢ã€‚
- æµ‹è¯•ç”¨ä¾‹ä¸ Mock å·¥å…·ã€‚
- æ–‡æ¡£ï¼šè®¡åˆ’ã€å®ç°è¯´æ˜ã€API è¯´æ˜ã€‚
- åˆæ­¥è¿ç»´æ‰‹å†Œï¼ˆé…ç½®ã€ç›‘æ§ã€å›æ»šï¼‰ã€‚

## ä¾èµ–ä¸é£é™©
- éœ€è¦ç¡®å®šæ•°æ®åº“è¿ç§»å·¥å…·é“¾ï¼ˆTortoise + Aerichï¼‰ã€‚
- OpenAI å…¼å®¹ç«¯ç‚¹ç¨³å®šæ€§ä¸å—æ§ï¼Œåº”è®¾ç½®è¶…æ—¶ä¸é‡è¯•ç­–ç•¥ã€‚
- Prompt ç¼–è¾‘å¸¦æ¥çš„æ ¼å¼é£é™©ï¼Œéœ€æä¾›æ¨¡æ¿æ ¡éªŒæˆ–æµ‹è¯•å…¥å£ã€‚
- å®¡è®¡æ—¥å¿—å¢é•¿å¯èƒ½å½±å“æ•°æ®åº“å¤§å°ï¼Œéœ€è§„åˆ’æ¸…ç†ç­–ç•¥ã€‚

## æµ‹è¯•ç­–ç•¥
- å•å…ƒï¼šPrompt Builderã€LLM Clientï¼ˆä½¿ç”¨ Mockï¼‰ã€API æƒé™ã€‚
- é›†æˆï¼š`/llm/chat` ä¸ `/llm/prompts` åœ¨æ²™ç®±ç¯å¢ƒå…¨é“¾è·¯æµ‹è¯•ã€‚
- ç§»åŠ¨ç«¯ï¼šMVI æµç¨‹è„šæœ¬è¦†ç›–åŠ è½½æ¨¡å‹ã€å‘é€æ¶ˆæ¯ã€æ¥æ”¶å“åº”ã€‚
- å›å½’ï¼šç¡®ä¿ç°æœ‰ç™»å½•ã€èœå•ã€æƒé™æ¨¡å—ä¸å—å½±å“ã€‚

## åç»­è¿­ä»£å±•æœ›
1. æµå¼å“åº”ï¼ˆSSE/WebSocketï¼‰ä¸å‰ç«¯æ¸è¿›å¼æ¸²æŸ“ã€‚
2. å¤šç§Ÿæˆ· / ä¸åŒè®¢é˜…è®¡åˆ’çš„æ¨¡å‹ä¸å¯†é’¥éš”ç¦»ã€‚
3. è‡ªåŠ¨ç”ŸæˆåµŒå…¥ä¸è¯­ä¹‰æ£€ç´¢æœåŠ¡ï¼Œå¤ç”¨ `exercise_fts`/`chat_vec` ç­‰è¡¨ã€‚
4. AI ä½¿ç”¨ç›‘æ§ä»ªè¡¨ç›˜ï¼ˆè°ƒç”¨é‡ã€æˆåŠŸç‡ã€å¹³å‡è€—æ—¶ï¼‰ã€‚
5. é•¿æœŸè®°å¿†ç®¡ç†ä¸ä¸Šä¸‹æ–‡è£å‰ªç­–ç•¥ä¼˜åŒ–ã€‚

## ğŸ“Œ åˆå¹¶èµ„æ–™

åŸè¿›åº¦ä¸æç¤ºæ–‡æ¡£çš„æ ¸å¿ƒä¿¡æ¯å·²æ•´åˆåœ¨æ­¤ï¼Œç»†èŠ‚äº¤ä»˜è®°å½•ä¿ç•™åœ¨ issue ä¸æäº¤å†å²ã€‚

- **AI Endpoint é¡¹ç›®è¿›åº¦è¿½è¸ª**ï¼ˆåŸ `progress.md`ï¼‰ï¼š> ç›‘ç®¡äººï¼šCodex ç›‘ç®¡ä»£ç†ï¼ˆè´Ÿè´£ Prompt ç¼–åˆ¶ã€è¿›åº¦ç£å¯¼ä¸å®¡æŸ¥ï¼‰
- **Agent-A å¼€å‘ä»»åŠ¡æ€»æç¤º**ï¼ˆåŸ `prompt_agent_a.md`ï¼‰ï¼šé¡¹ç›®ç›®æ ‡ï¼šå®ç° GymBro AI Endpointï¼ˆå‚ç…§ `docs/features/ai_endpoint/plan.md`ï¼‰ã€‚
